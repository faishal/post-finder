/*! Post Finder - v0.2
 * 
 * Copyright (c) 2018; */
"use strict";!function(a,b,c,d){var e={};b.postFinder=function(a,d){var f,g,h,i;g="mainTemplate"in e?e.mainTemplate:e.mainTemplate=b("#tmpl-post-finder-main").html(),h="itemTemplate"in e?e.itemTemplate:e.itemTemplate=b("#tmpl-post-finder-item").html(),f={template:g,fieldSelector:"input[type=hidden]",typesfieldSelector:"input#types[type=hidden]",selectSelector:"select",listSelector:".list",searchSelector:".search",resultsSelector:".results",querySelector:"input[type=text]",nonceSelector:"#post_finder_nonce"};var j=this;j.cache={},j.posts={},j.settings={};var k=b(a);j.init=function(){j.settings=b.extend({},f,d),j.$field=k.find(j.settings.fieldSelector),j.$typefield=k.find(j.settings.typesfieldSelector),j.$select=k.find(j.settings.selectSelector),j.$list=k.find(j.settings.listSelector),j.$search=k.find(j.settings.searchSelector),j.$results=j.$search.find(j.settings.resultsSelector),j.$query=j.$search.find(j.settings.querySelector),j.nonce=b(j.settings.nonceSelector).val(),j.posts=c.reduce(b.extend({},k.data("posts")),function(a,b){return a[b.ID]=b,a},{}),j.recent=c.reduce(b.extend({},k.data("recent")),function(a,b){return a[b.ID]=b,a},{}),j.$select.on("change",function(){j.addItem(b(this).val(),b("option:selected",this).text(),b("option:selected",this).data("permalink"))}),j.$search.on("click",".button",function(a){a.preventDefault(),j.search(a)}),j.$search.on("keypress",'input[type="text"]',function(a){13===a.which&&(a.preventDefault(),j.search(a))}),j.$list.sortable({placeholder:"placeholder",update:function(){j.serialize()}}),j.$list.on("click",".delete",function(a){a.preventDefault(),j.removeItem(b(this).closest("li").data("id"))}),j.$results.on("click",".add",function(a){a.preventDefault(),i=b(this).closest("li"),j.addItem(i.data("id"),i.find("span").text(),i.data("permalink"))}),j.$list.on("keypress","li input.position",function(a){13===a.which&&(a.preventDefault(),b(this).trigger("blur"))}),j.$list.on("blur","li input.position",function(){j.moveItem(b(this).closest("li"),b(this).val())})},j.moveItem=function(a,b){var c,d=j.$list.find("li"),e=d.length;return b>e||b<1?(alert("Please pick a position between 1 and "+e),!1):b-1!==a.index()&&(c=a.clone(),1===b?j.$list.prepend(c):b>1&&b<e?j.$list.find("li").eq(b-1).before(c):b===e&&j.$list.append(c),a.remove(),void j.serialize())},j.addItem=function(a,b,d){var e=c.template(j.settings.template);if(0!==a){if(j.$list.find("li").length>=k.data("limit"))return void alert(POST_FINDER_CONFIG.max_number_allowed);if(j.$list.find('li[data-id="'+a+'"]').length)return void alert(POST_FINDER_CONFIG.already_added);j.cache[a]?j.posts[a]=c.clone(j.cache[a]):j.recent[a]&&(j.posts[a]=c.clone(j.recent[a])),j.$list.append(e({id:a,title:b,editUrl:POST_FINDER_CONFIG.adminurl+"post.php?post="+a+"&action=edit",permalink:d,pos:j.$list.length+1})),j.$list.find(".notice").hide(),j.$select.find('option[value="'+a+'"]').remove(),j.serialize()}},j.removeItem=function(a){j.$list.find('li[data-id="'+a+'"]').remove(),j.serialize(),0===j.$list.find("li").length&&j.$list.find(".notice").show()},j.search=function(a){var d="",e=a.currentTarget.getAttribute("data-page")?Number(a.currentTarget.getAttribute("data-page")):1,f={action:"pf_search_posts",s:j.$query.val(),page:e,_ajax_nonce:j.nonce},g=e+1,i=c.template(h);f=b.extend(f,k.data("args")),j.$search.addClass("loading"),b.ajax(ajaxurl,{type:"POST",data:f,dataType:"json",success:function(a){if(void 0!==a.posts){if(a.posts.length>0){j.cache=[];for(var b in a.posts)j.cache[a.posts[b].ID]=a.posts[b],d+=i(a.posts[b]);a.posts.length===pfPerPage&&(d+='<li class="next">',d+='<a href="#" class="button" data-page="'+g+'">',d+=POST_FINDER_CONFIG.next,d+="</a>",d+="</li>")}else d="<li>"+POST_FINDER_CONFIG.nothing_found+"</li>";j.$search.removeClass("loading"),j.$results.html(d)}}})},j.serialize=function(){var a=[],c=[],d=1;j.$list.find("li").each(function(){b(this).find("input.position").val(d),a.push(b(this).data("id")),c.push(b(this).data("type")),d++}),j.$field.val(a.join(",")),j.$typefield.val(c.join(",")),b(document).trigger("updatePostfinder",{idField:j.$field,typeField:j.$typefield})},j.init()},b.fn.postFinder=function(a){return this.each(function(){if(d===b(this).data("postFinder")){var c=new b.postFinder(this,a);b(this).data("postFinder",c)}})}}(window,jQuery,_);